<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Siêu Nhẹ</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: sans-serif; }
        
        /* Giao diện danh sách kênh */
        #list-screen { padding: 10px; padding-bottom: 50px; }
        .channel-box { 
            background: #222; margin-bottom: 12px; padding: 18px; 
            font-size: 22px; border-radius: 8px; cursor: pointer; 
            border-left: 6px solid #e50914; 
        }
        .channel-box:active { background: #444; }
        
        /* Giao diện xem video */
        #player-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; }
        video { width: 100%; height: 100%; }
        
        /* Nút quay lại (To và dễ bấm trên TV) */
        #back-btn { 
            position: fixed; top: 20px; left: 20px; padding: 15px 30px; 
            font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.8); 
            color: #fff; border: 2px solid #fff; border-radius: 8px; 
            z-index: 200; cursor: pointer; 
        }
    </style>
</head>
<body>

    <div id="list-screen">
        <h2 id="status-text" style="text-align:center; color: #00ff00;">Đang tải dữ liệu...</h2>
        <div id="channels-container"></div>
    </div>

    <div id="player-screen">
        <button id="back-btn" onclick="stopAndBack()">⬅ QUAY LẠI</button>
        <video id="tv-screen" controls playsinline></video>
    </div>

    <script>
        // --- CHỈ ĐỌC DUY NHẤT FILE NÀY ---
        var sourceUrl = 'https://raw.githubusercontent.com/HDHTN/BDL/main/hfb_list.m3u';
        
        var listScreen = document.getElementById('list-screen');
        var playerScreen = document.getElementById('player-screen');
        var channelsContainer = document.getElementById('channels-container');
        var statusText = document.getElementById('status-text');
        var video = document.getElementById('tv-screen');
        var hlsPlayer;

        // 1. Hàm tải file M3U (Chống cache bằng tham số thời gian)
        function fetchChannels() {
            var finalUrl = sourceUrl + '?t=' + new Date().getTime();
            
            fetch(finalUrl)
                .then(function(response) {
                    if (!response.ok) throw new Error('Từ chối kết nối');
                    return response.text();
                })
                .then(function(text) {
                    processData(text);
                })
                .catch(function(error) {
                    statusText.innerHTML = '<span style="color:red">Lỗi tải danh sách: ' + error.message + '</span>';
                });
        }

        // 2. Hàm "Lọc rác" và trích xuất kênh
        function processData(text) {
            var lines = text.split('\n');
            var htmlOutput = '';
            var tempName = "Kênh không tên";
            var count = 0;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                
                // Nếu là dòng chứa tên kênh
                if (line.indexOf('#EXTINF') === 0) {
                    var commaIndex = line.indexOf(',');
                    if (commaIndex !== -1) {
                        tempName = line.substring(commaIndex + 1).trim();
                    }
                } 
                // Nếu là dòng chứa link video (Bỏ qua mọi dòng rác == hoặc -- ở giữa)
                else if (line.indexOf('http') === 0) {
                    htmlOutput += '<div class="channel-box" onclick="playChannel(\'' + line + '\')">' + tempName + '</div>';
                    tempName = "Kênh không tên"; // Reset tên để chuẩn bị cho kênh tiếp theo
                    count++;
                }
            }

            // Hiển thị kết quả
            if (count > 0) {
                statusText.innerHTML = '<span style="color:orange">Đã tải ' + count + ' kênh</span>';
                statusText.style.textAlign = 'left';
                channelsContainer.innerHTML = htmlOutput;
            } else {
                statusText.innerHTML = '<span style="color:yellow">File M3U chưa có link video hợp lệ.</span>';
            }
        }

        // 3. Hàm phát video
        function playChannel(streamUrl) {
            // Chuyển màn hình
            listScreen.style.display = 'none';
            playerScreen.style.display = 'block';

            if (Hls.isSupported()) {
                if (hlsPlayer) hlsPlayer.destroy(); // Dọn dẹp luồng cũ
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(streamUrl);
                hlsPlayer.attachMedia(video);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                    video.play();
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Chạy mượt trên iPhone/iPad
                video.src = streamUrl;
                video.play();
            }
        }

        // 4. Hàm quay lại danh sách
        function stopAndBack() {
            video.pause();
            video.src = "";
            if (hlsPlayer) hlsPlayer.destroy();
            
            playerScreen.style.display = 'none';
            listScreen.style.display = 'block';
        }

        // Tự động chạy khi mở file
        fetchChannels();
    </script>
</body>
</html>
