    <script>
        const M3U_URL = 'https://raw.githubusercontent.com/HDHTN/BDL/main/hfb_list.m3u';
        
        const v = document.getElementById('v');
        const list = document.getElementById('list');
        const menu = document.getElementById('menu');
        const btn = document.getElementById('back-btn');

        async function load() {
            try {
                // Thêm cache-control để ép tải file mới nhất
                const res = await fetch(M3U_URL + '?t=' + Date.now());
                const text = await res.text();
                const lines = text.split(/\r?\n/); // Xử lý cả xuống dòng kiểu Windows và Linux
                let html = '';
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if (line.startsWith('#EXTINF')) {
                        // Lấy tên kênh sau dấu phẩy
                        let name = line.split(',')[1] || "Kênh không tên";
                        
                        // QUAN TRỌNG: Tìm link http ở các dòng tiếp theo (phòng trường hợp có dòng trống)
                        let url = "";
                        for (let j = i + 1; j < i + 5 && j < lines.length; j++) {
                            if (lines[j].trim().startsWith('http')) {
                                url = lines[j].trim();
                                break;
                            }
                        }

                        if (url) {
                            html += `<div class="ch" onclick="play('${url}')">${name}</div>`;
                        }
                    }
                }
                list.innerHTML = html || '<div class="ch">Danh sách trống! (Kiểm tra nội dung file hfb_list.m3u)</div>';
            } catch (e) { 
                list.innerHTML = '<div class="ch">Lỗi kết nối M3U!</div>'; 
            }
        }

        function play(url) {
            menu.style.display = 'none';
            btn.style.display = 'block';
            
            // Xử lý HLS cho TV Sony và iPhone
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(v);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    v.play().catch(() => {
                        console.log("Cần bấm nút Play để phát");
                    });
                });
                // Xử lý lỗi nếu link stream chết
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) { alert("Link này hiện không xem được!"); }
                });
            } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
                v.src = url;
                v.play();
            }
        }

        function showMenu() {
            v.pause();
            menu.style.display = 'block';
            btn.style.display = 'none';
        }

        load();
    </script>
