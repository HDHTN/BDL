<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Si√™u Nh·∫π</title>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: sans-serif; overflow-x: hidden; }
        
        #list-screen { padding: 10px; padding-bottom: 50px; }
        .channel-box { background: #222; margin-bottom: 12px; padding: 18px; font-size: 22px; border-radius: 8px; cursor: pointer; border-left: 6px solid #e50914; transition: 0.2s; }
        .channel-box:active, .channel-box:focus { background: #555; outline: 3px solid #fff; }
        
        #player-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }
        
        /* N√∫t quay l·∫°i hi·ªÉn th·ªã tr√™n TV */
        #back-btn { position: absolute; top: 20px; left: 20px; z-index: 101; background: rgba(0,0,0,0.6); color: white; padding: 12px 24px; border: 2px solid white; border-radius: 6px; cursor: pointer; font-size: 20px; display: none; font-weight: bold; }
        #back-btn:focus { background: #e50914; outline: none; }
    </style>
</head>
<body>

    <div id="list-screen">
        <h2 id="status-text" style="text-align:center; color: #00ff00;">ƒêang t·∫£i d·ªØ li·ªáu...</h2>
        <div id="channels-container"></div>
    </div>

    <div id="player-screen">
        <button id="back-btn" onclick="stopPlayer()">üîô Quay L·∫°i</button>
        <video id="tv-screen" controls playsinline autoplay>
            <source id="video-source" src="" type="application/x-mpegURL">
            Tr√¨nh duy·ªát TV c·ªßa b·∫°n qu√° c≈©.
        </video>
    </div>

    <script>
        // ==========================================
        // C·∫§U H√åNH C√îNG TH·ª®C LINK C·ª¶A B·∫†N T·∫†I ƒê√ÇY
        // ==========================================
        var URL_PREFIX = "https://pull.niues.live/live/stream-";
        var URL_SUFFIX = "_lhd.m3u8";

        var sourceUrl = 'https://raw.githubusercontent.com/HDHTN/BDL/refs/heads/main/hfb_list.m3u';
        
        var listScreen = document.getElementById('list-screen');
        var playerScreen = document.getElementById('player-screen');
        var channelsContainer = document.getElementById('channels-container');
        var statusText = document.getElementById('status-text');
        
        var video = document.getElementById('tv-screen');
        var videoSource = document.getElementById('video-source');
        var backBtn = document.getElementById('back-btn');
        var hideBtnTimeout;

        function fetchChannels() {
            var finalUrl = sourceUrl + '?t=' + new Date().getTime();
            fetch(finalUrl)
                .then(function(response) {
                    if (!response.ok) throw new Error('L·ªói m·∫°ng');
                    return response.text();
                })
                .then(function(text) { processData(text); })
                .catch(function(error) {
                    statusText.innerHTML = '<span style="color:red">L·ªói t·∫£i danh s√°ch.</span>';
                });
        }

        function processData(text) {
            var lines = text.split('\n');
            var htmlOutput = '';
            var tempName = "K√™nh kh√¥ng t√™n";
            var count = 0;

            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (line.indexOf('#EXTINF') === 0) {
                    var commaIndex = line.indexOf(',');
                    if (commaIndex !== -1) { tempName = line.substring(commaIndex + 1).trim(); }
                } 
                else if (line.indexOf('http') === 0) {
                    // Th√™m tabindex ƒë·ªÉ c√≥ th·ªÉ d√πng ph√≠m ƒëi·ªÅu h∆∞·ªõng (l√™n/xu·ªëng) tr√™n remote TV
                    htmlOutput += '<div class="channel-box" tabindex="0" onclick="playChannel(\'' + line + '\')" onkeypress="if(event.keyCode==13) playChannel(\'' + line + '\')">' + tempName + '</div>';
                    tempName = "K√™nh kh√¥ng t√™n"; 
                    count++;
                }
            }

            if (count > 0) {
                statusText.innerHTML = '<span style="color:orange">ƒê√£ t·∫£i ' + count + ' k√™nh</span>';
                statusText.style.textAlign = 'left';
                channelsContainer.innerHTML = htmlOutput;
            } else {
                statusText.innerHTML = '<span style="color:yellow">Kh√¥ng c√≥ k√™nh n√†o.</span>';
            }
        }

        // --- PH·∫¶N PH√ÅT VIDEO CH√çNH TH·ª®C ---
        function playChannel(streamUrl) {
            listScreen.style.display = 'none';
            playerScreen.style.display = 'block';

            // Hi·ªán n√∫t Quay L·∫°i 5 gi√¢y r·ªìi ·∫©n ƒëi cho ƒë·ª° v∆∞·ªõng m√†n h√¨nh
            showBackButton();

            videoSource.src = "";
            video.removeAttribute('src'); 

            // PH√âP THU·∫¨T N·∫∞M ·ªû ƒê√ÇY: D·ªãch m√£ linh ho·∫°t
            // Ki·ªÉm tra xem link ƒë√£ l√† m3u8 tr·ª±c ti·∫øp ch∆∞a. N·∫øu ch∆∞a, t√¨m s·ªë ID v√† gh√©p n·ªëi.
            if (streamUrl.indexOf('.m3u8') === -1) {
                var match = streamUrl.match(/(\d{5,8})/);
                if (match) {
                    var id = match[1];
                    streamUrl = URL_PREFIX + id + URL_SUFFIX;
                }
            }

            // Giao link ƒë√£ x·ª≠ l√Ω cho TV ph√°t
            videoSource.src = streamUrl;
            video.load();
            
            var playPromise = video.play();
            if (playPromise !== undefined) {
                playPromise.catch(function(error) { console.log("C·∫ßn t·ª± b·∫•m Play."); });
            }
        }

        function stopPlayer() {
            video.pause();
            videoSource.src = "";
            video.removeAttribute('src');
            video.load();
            playerScreen.style.display = 'none';
            listScreen.style.display = 'block';
        }

        function showBackButton() {
            backBtn.style.display = 'block';
            clearTimeout(hideBtnTimeout);
            hideBtnTimeout = setTimeout(function() { backBtn.style.display = 'none'; }, 5000);
        }

        // Hi·ªán n√∫t Quay l·∫°i khi ch·∫°m/di chuy·ªÉn chu·ªôt/b·∫•m ph√≠m
        playerScreen.addEventListener('mousemove', showBackButton);
        playerScreen.addEventListener('touchstart', showBackButton);

        // B·∫Øt s·ª± ki·ªán ph√≠m Quay l·∫°i tr√™n Remote TV (Esc, Backspace, ph√≠m Back WebOS/Tizen)
        window.addEventListener('keydown', function(e) {
            if (playerScreen.style.display === 'block') {
                if (e.keyCode === 27 || e.keyCode === 8 || e.keyCode === 10009) {
                    e.preventDefault();
                    stopPlayer();
                } else {
                    showBackButton();
                }
            }
        });

        // Kh√¥i ph·ª•c n·∫øu ƒë·ª©t m·∫°ng
        video.addEventListener('error', function() {
            if (playerScreen.style.display === 'block') {
                setTimeout(function() {
                    video.load();
                    video.play();
                }, 5000);
            }
        }, true);

        fetchChannels();
    </script>
</body>
</html>
